---

- name: Deploy librenms docker-compose
  ansible.builtin.include_role:
    name: docker_compose
  vars:
    docker_compose_project_name: librenms

    docker_compose_services:
      db:
        image: "{{ librenms_mariadb_docker_repository }}:{{ librenms_mariadb_docker_tag }}"
        command:
          - mysqld
          - --innodb-file-per-table=1
          - --lower-case-table-names=0
          - --character-set-server=utf8mb4
          - --collation-server=utf8mb4_unicode_ci
        environment:
          MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
          MYSQL_USER: librenms
          MYSQL_PASSWORD: librenms
          MYSQL_DATABASE: librenms
        volumes:
          - db:/var/lib/mysql

      librenms:
        image: "{{ librenms_docker_repository }}:{{ librenms_docker_tag }}"
        hostname: librenms
        cap_add:
          - NET_ADMIN
          - NET_RAW
        depends_on:
          - librenms_db
        environment:
          SESSION_DRIVER: redis
          CACHE_DRIVER: redis
          REDIS_HOST: "{{ librenms_redis_host }}"
          REDIS_PORT: "{{ librenms_redis_port }}"
          DB_HOST: librenms_db
          DB_USER: librenms
          DB_PASSWORD: librenms
          DB_NAME: librenms
          LIBRENMS_WEATHERMAP: "true"
        networks:
          - default
        volumes:
          - data:/data
        reverse_proxy: "{{ librenms_reverse_proxy_computed }}"

      dispatcher:
        image: "{{ librenms_docker_repository }}:{{ librenms_docker_tag }}"
        hostname: librenms-dispatcher
        cap_add:
          - NET_ADMIN
          - NET_RAW
        depends_on:
          - librenms_librenms
        environment:
          SESSION_DRIVER: redis
          CACHE_DRIVER: redis
          REDIS_HOST: "{{ librenms_redis_host }}"
          REDIS_PORT: "{{ librenms_redis_port }}"
          DB_HOST: librenms_db
          DB_USER: librenms
          DB_PASSWORD: librenms
          DB_NAME: librenms
          LIBRENMS_WEATHERMAP: "true"
          SIDECAR_DISPATCHER: "1"
          DISPATCHER_NODE_ID: "dispatcher1"
        volumes:
          - data:/data

    docker_compose_volumes_dir_owner: 1000
    docker_compose_volumes_dir_group: 1000
    docker_compose_volumes_dir_mode: 0755
