---
- name: Add Zerotier repo to sources list
  ansible.builtin.deb822_repository:
    name: zerotier
    types:
      - deb
    uris:
      - "https://download.zerotier.com/debian/{{ ansible_distribution_release }}"
    suites:
      - "{{ ansible_distribution_release }}"
    components:
      - main
    signed_by: https://download.zerotier.com/contact@zerotier.com.gpg
  register: zerotier_repo_add

- name: Install Zerotier
  ansible.builtin.apt:
    name: zerotier-one
    update_cache: "{{ zerotier_repo_add.changed }}"

- name: Configure Zerotier
  ansible.builtin.copy:
    content: "{{ zerotier_config_computed | to_json }}"
    dest: /var/lib/zerotier-one/local.conf
    owner: zerotier-one
    group: zerotier-one
    mode: 0644
  notify: Restart Zerotier

- name: Configure devicemap
  ansible.builtin.copy:
    content: |
      {% for network_id, interface in zerotier_devicemap.items() %}
      {{ network_id }}={{ interface }}
      {% endfor %}
    dest: /var/lib/zerotier-one/devicemap
    owner: zerotier-one
    group: zerotier-one
    mode: 0644
  notify: Restart Zerotier

- name: Configure network
  ansible.builtin.include_tasks: network.yml
  loop: "{{ zerotier_networks }}"
  loop_control:
    loop_var: network
