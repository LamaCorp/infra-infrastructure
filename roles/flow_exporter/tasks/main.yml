---

- name: Deploy flow-exporter docker-compose
  ansible.builtin.include_role:
    name: docker_compose
  vars:
    docker_compose_project_name: flow_exporter

    docker_compose_services:
      kafka:
        image: "{{ flow_exporter_kafka_docker_repository }}:{{ flow_exporter_kafka_docker_tag }}"
        environment:
          KAFKA_ENABLE_KRAFT: "yes"
          KAFKA_CFG_PROCESS_ROLES: broker,controller
          KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
          KAFKA_CFG_LISTENERS: CONTROLLER://:9093,CLIENT://:19092,EXTERNAL://:9092
          KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,CLIENT:PLAINTEXT,EXTERNAL:PLAINTEXT
          KAFKA_CFG_ADVERTISED_LISTENERS: "CLIENT://flow_exporter_kafka:19092,EXTERNAL://{{ inventory_hostname }}:9092"
          KAFKA_CFG_INTER_BROKER_LISTENER_NAME: CLIENT
          KAFKA_BROKER_ID: 1
          KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@127.0.0.1:9093
          ALLOW_PLAINTEXT_LISTENER: "yes"
          KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
          KAFKA_CFG_LOG_RETENTION_HOURS: 1

      exporter:
        image: "{{ flow_exporter_docker_repository }}:{{ flow_exporter_docker_tag }}"
        command:
          - --brokers=flow_exporter_kafka:19092
          - --topic=pmacct.acct
          - "--asn={{ flow_exporter_asn }}"
        networks:
          - default
        monitoring:
          name: flow-exporter
          port: 9590
