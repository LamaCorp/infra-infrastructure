---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-observability-thanos
  labels:
    app: infra-observability-thanos
spec:
  project: infra
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
    automated:
      prune: true
  destination:
    name: k3s.fsn.as212024.net
    namespace: infra-observability
  source:
    repoURL: registry-1.docker.io/bitnamicharts
    targetRevision: 16.0.4
    chart: thanos
    helm:
      releaseName: thanos
      values: |
        clusterDomain: c.k3s.fsn.as212024.net
        existingObjstoreSecret: thanos-objstore

        compactor:
          enabled: false
          annotations:
            secret.reloader.stakater.com/reload: thanos-objstore
          retentionResolutionRaw: 30d
          retentionResolution5m: 90d
          retentionResolution1h: 0d
          extraFlags:
            - --deduplication.func=penalty
            - --compact.enable-vertical-compaction
            - --deduplication.replica-label=prometheus_replica
            - --hash-func=SHA256
          persistence:
            size: 10Gi

        storegateway:
          enabled: true
          annotations:
            secret.reloader.stakater.com/reload: thanos-objstore

        query:
          enabled: true
          dnsDiscovery:
            sidecarsService: kube-prometheus-stack-thanos-discovery
            sidecarsNamespace: core-observability
          replicaLabel:
            - prometheus_replica

        bucketweb:
          enabled: true
          annotations:
            secret.reloader.stakater.com/reload: thanos-objstore

        queryFrontend:
          enabled: true

        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
          prometheusRule:
            enabled: true
            default:
              create: true
              disabled:
                # We're not using the receiver nor the ruler
                ThanosReceiveIsDown: true
                ThanosRuleIsDown: true
                # This is handled by kube-prometheus-stack
                ThanosSidecarIsDown: true
                ThanosCompactIsDown: true
                ThanosStoreIsDown: true
